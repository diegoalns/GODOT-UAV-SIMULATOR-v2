class_name DebugLogger
extends Node

# ============================================================================
# NOTE: This is an autoload singleton
# ============================================================================
# When DebugLogger is added as an autoload singleton in Project Settings,
# it becomes accessible globally. However, since we also use class_name,
# we need to access the singleton instance, not the class.
#
# Access the singleton instance via: get_node("/root/DebugLogger")
# Or use a helper variable: var logger = DebugLogger (if autoload is named DebugLogger)
# ============================================================================

# ============================================================================
# LOG LEVELS - Enum for message importance
# ============================================================================
enum LogLevel {
	DEBUG = 0,    # Detailed diagnostic information
	INFO = 1,    # General informational messages
	WARNING = 2, # Warning messages
	ERROR = 3    # Error conditions
}

# ============================================================================
# VERBOSITY LEVELS - Control detail level of output
# ============================================================================
enum VerbosityLevel {
	SILENT = 0,   # Only errors
	MINIMAL = 1,  # Only critical operations
	NORMAL = 2,   # Standard operations (default)
	VERBOSE = 3   # All operations including debug details
}

# ============================================================================
# CATEGORIES - Message categories for filtering
# ============================================================================
enum Category {
	ROUTE,         # Route pre-request manager operations
	WEBSOCKET,     # WebSocket connection/communication
	DRONE,         # Drone creation/management
	SIMULATION,    # Simulation engine updates
	TERRAIN,       # Terrain/gridmap operations
	VISUALIZATION, # Visualization system
	HEAP,          # Heap operations
	FLIGHT_PLAN,   # Flight plan management
	GENERAL        # General/unclassified messages
}

# ============================================================================
# CONFIGURATION - Logging settings
# ============================================================================
# Current log level - only messages at or above this level will be printed
var current_log_level: LogLevel = LogLevel.INFO

# Current verbosity level - controls detail level of output
var current_verbosity: VerbosityLevel = VerbosityLevel.NORMAL

# Category enable/disable flags - Dictionary mapping Category enum to bool
var category_enabled: Dictionary = {}

# Enable timestamps in log messages
var show_timestamps: bool = true

# Enable color coding (if console supports ANSI colors)
var use_colors: bool = false

# Reference to simulation engine for getting simulation time
var simulation_engine: Node = null

# ============================================================================
# INITIALIZATION
# ============================================================================
func _ready():
	# Initialize all categories as enabled by default
	for category in Category.values():
		category_enabled[category] = true
	
	# Try to find simulation engine for timestamps (will be set up after simulation starts)
	# Don't log here to avoid circular initialization issues
	# simulation_engine will be set when first accessed via get_current_simulation_time()

# ============================================================================
# LOGGING METHODS - Main interface for logging
# ============================================================================
func log_debug(category: Category, message: String, data: Dictionary = {}):
	"""
	Log a DEBUG level message with optional data dictionary.
	
	Args:
		category: Category - Message category for filtering
		message: String - Message text to log
		data: Dictionary - Optional additional data (default: empty)
	"""
	log_message(LogLevel.DEBUG, category, message, data)

func log_info(category: Category, message: String, data: Dictionary = {}):
	"""
	Log an INFO level message with optional data dictionary.
	
	Args:
		category: Category - Message category for filtering
		message: String - Message text to log
		data: Dictionary - Optional additional data (default: empty)
	"""
	log_message(LogLevel.INFO, category, message, data)

func log_warning(category: Category, message: String, data: Dictionary = {}):
	"""
	Log a WARNING level message with optional data dictionary.
	
	Args:
		category: Category - Message category for filtering
		message: String - Message text to log
		data: Dictionary - Optional additional data (default: empty)
	"""
	log_message(LogLevel.WARNING, category, message, data)

func log_error(category: Category, message: String, data: Dictionary = {}):
	"""
	Log an ERROR level message with optional data dictionary.
	Also calls push_error() for Godot error system integration.
	
	Args:
		category: Category - Message category for filtering
		message: String - Message text to log
		data: Dictionary - Optional additional data (default: empty)
	"""
	log_message(LogLevel.ERROR, category, message, data)
	# Also push to Godot error system
	push_error("[%s] %s" % [Category.keys()[category], message])

# ============================================================================
# CORE LOGGING LOGIC
# ============================================================================
func log_message(level: LogLevel, category: Category, message: String, data: Dictionary = {}):
	"""
	Core logging method that handles filtering and formatting.
	
	Args:
		level: LogLevel - Message importance level
		category: Category - Message category
		message: String - Message text
		data: Dictionary - Optional additional data
	"""
	# Check if message should be logged based on level
	if level < current_log_level:
		return  # Message level too low, skip
	
	# Check if category is enabled
	if not category_enabled.get(category, true):
		return  # Category disabled, skip
	
	# Format and print the message
	var formatted_message = format_message(level, category, message, data)
	print(formatted_message)

func format_message(level: LogLevel, category: Category, message: String, data: Dictionary) -> String:
	"""
	Format a log message with level, category, timestamp, and optional data.
	
	Args:
		level: LogLevel - Message importance level
		category: Category - Message category
		message: String - Message text
		data: Dictionary - Optional additional data
	
	Returns:
		String - Formatted log message
	"""
	var parts: Array = []  # Array: Parts of the formatted message
	
	# Add timestamp if enabled
	if show_timestamps:
		var timestamp = get_timestamp()  # String: Formatted timestamp
		parts.append("[%s]" % timestamp)
	
	# Add log level
	var level_str = LogLevel.keys()[level]  # String: Log level name
	parts.append("[%s]" % level_str)
	
	# Add category
	var category_str = Category.keys()[category]  # String: Category name
	parts.append("[%s]" % category_str)
	
	# Add message
	parts.append(message)
	
	# Add data if present and verbosity allows
	if not data.is_empty() and current_verbosity >= VerbosityLevel.VERBOSE:
		var data_str = format_data(data)  # String: Formatted data dictionary
		parts.append(" | Data: %s" % data_str)
	
	# Join all parts with spaces
	return " ".join(parts)

func format_data(data: Dictionary) -> String:
	"""
	Format a data dictionary as a string for logging.
	
	Args:
		data: Dictionary - Data to format
	
	Returns:
		String - Formatted data string
	"""
	var parts: Array = []  # Array: Formatted key-value pairs
	for key in data.keys():
		var value = data[key]  # Value to format
		var value_str = str(value)  # String: String representation of value
		parts.append("%s=%s" % [key, value_str])
	return "{%s}" % ", ".join(parts)

func get_timestamp() -> String:
	"""
	Get current timestamp for log messages.
	Uses simulation time if available, otherwise system time.
	
	Returns:
		String - Formatted timestamp
	"""
	var sim_time = get_current_simulation_time()  # float: Simulation time (or 0.0 if not available)
	if sim_time > 0.0:
		# Use simulation time if available
		return "%.2fs" % sim_time
	else:
		# Fallback to system time
		var system_time = Time.get_unix_time_from_system()  # float: System time
		return "%.2fs" % system_time

# ============================================================================
# CONFIGURATION METHODS - Control logging behavior
# ============================================================================
func set_log_level(level: LogLevel):
	"""
	Set the minimum log level. Only messages at or above this level will be printed.
	
	Args:
		level: LogLevel - Minimum log level to display
	"""
	current_log_level = level
	log_info(Category.GENERAL, "Log level set to: %s" % LogLevel.keys()[level])

func set_verbosity(verbosity: VerbosityLevel):
	"""
	Set the verbosity level. Controls detail level of output.
	
	Args:
		verbosity: VerbosityLevel - Verbosity level to use
	"""
	current_verbosity = verbosity
	log_info(Category.GENERAL, "Verbosity set to: %s" % VerbosityLevel.keys()[verbosity])

func set_category_enabled(category: Category, enabled: bool):
	"""
	Enable or disable a specific message category.
	
	Args:
		category: Category - Category to enable/disable
		enabled: bool - True to enable, False to disable
	"""
	category_enabled[category] = enabled
	var status = "enabled" if enabled else "disabled"  # String: Status text
	log_info(Category.GENERAL, "Category %s %s" % [Category.keys()[category], status])

func enable_all_categories():
	"""Enable all message categories."""
	for category in Category.values():
		category_enabled[category] = true
	log_info(Category.GENERAL, "All categories enabled")

func disable_all_categories():
	"""Disable all message categories."""
	for category in Category.values():
		category_enabled[category] = false
	log_info(Category.GENERAL, "All categories disabled")

func set_timestamps_enabled(enabled: bool):
	"""
	Enable or disable timestamps in log messages.
	
	Args:
		enabled: bool - True to show timestamps, False to hide
	"""
	show_timestamps = enabled

# ============================================================================
# CONVENIENCE METHODS - Quick access for common operations
# ============================================================================
func log_route_debug(message: String, data: Dictionary = {}):
	"""Convenience method for route debug messages."""
	log_debug(Category.ROUTE, message, data)

func log_route_info(message: String, data: Dictionary = {}):
	"""Convenience method for route info messages."""
	log_info(Category.ROUTE, message, data)

func log_route_warning(message: String, data: Dictionary = {}):
	"""Convenience method for route warning messages."""
	log_warning(Category.ROUTE, message, data)

func log_route_error(message: String, data: Dictionary = {}):
	"""Convenience method for route error messages."""
	log_error(Category.ROUTE, message, data)

func log_websocket_info(message: String, data: Dictionary = {}):
	"""Convenience method for WebSocket info messages."""
	log_info(Category.WEBSOCKET, message, data)

func log_websocket_warning(message: String, data: Dictionary = {}):
	"""Convenience method for WebSocket warning messages."""
	log_warning(Category.WEBSOCKET, message, data)

func log_websocket_error(message: String, data: Dictionary = {}):
	"""Convenience method for WebSocket error messages."""
	log_error(Category.WEBSOCKET, message, data)

func log_drone_info(message: String, data: Dictionary = {}):
	"""Convenience method for drone info messages."""
	log_info(Category.DRONE, message, data)

func log_drone_debug(message: String, data: Dictionary = {}):
	"""Convenience method for drone debug messages."""
	log_debug(Category.DRONE, message, data)

func log_simulation_info(message: String, data: Dictionary = {}):
	"""Convenience method for simulation info messages."""
	log_info(Category.SIMULATION, message, data)

# ============================================================================
# SINGLETON ACCESS HELPER - Get singleton instance
# ============================================================================
static func get_instance() -> Node:
	"""
	Get the DebugLogger singleton instance.
	Use this when class_name conflicts with singleton access.
	
	Returns:
		Node - DebugLogger singleton instance, or null if not found
	"""
	return Engine.get_main_loop().root.get_node_or_null("/root/DebugLogger")

# ============================================================================
# UTILITY METHODS - Helper functions
# ============================================================================
func get_stats() -> Dictionary:
	"""
	Get statistics about current logging configuration.
	
	Returns:
		Dictionary - Statistics with keys:
			- log_level: String - Current log level name
			- verbosity: String - Current verbosity level name
			- enabled_categories: Array - List of enabled category names
			- disabled_categories: Array - List of disabled category names
			- timestamps_enabled: bool - Whether timestamps are shown
	"""
	var enabled: Array = []  # Array: Enabled category names
	var disabled: Array = []  # Array: Disabled category names
	
	for category in Category.values():
		var category_name = Category.keys()[category]  # String: Category name
		if category_enabled.get(category, true):
			enabled.append(category_name)
		else:
			disabled.append(category_name)
	
	return {
		"log_level": LogLevel.keys()[current_log_level],
		"verbosity": VerbosityLevel.keys()[current_verbosity],
		"enabled_categories": enabled,
		"disabled_categories": disabled,
		"timestamps_enabled": show_timestamps
	}

# ============================================================================
# VERBOSITY HELPER METHODS - Check if certain outputs should be shown
# ============================================================================
func should_show_tables() -> bool:
	"""
	Check if table outputs should be shown based on verbosity level.
	Tables are only shown in VERBOSE mode.
	
	Returns:
		bool - True if tables should be shown, False otherwise
	"""
	return current_verbosity >= VerbosityLevel.VERBOSE

func should_show_verbose() -> bool:
	"""
	Check if verbose outputs should be shown based on verbosity level.
	Verbose outputs are shown in VERBOSE mode.
	
	Returns:
		bool - True if verbose outputs should be shown, False otherwise
	"""
	return current_verbosity >= VerbosityLevel.VERBOSE

func should_show_debug_details() -> bool:
	"""
	Check if debug details should be shown based on verbosity level.
	Debug details are shown in VERBOSE mode.
	
	Returns:
		bool - True if debug details should be shown, False otherwise
	"""
	return current_verbosity >= VerbosityLevel.VERBOSE

# ============================================================================
# SIMULATION TIME ACCESS - Helper for getting simulation time
# ============================================================================
func get_current_simulation_time() -> float:
	"""
	Get current simulation time if available.
	Used by timestamp formatting.
	
	Returns:
		float - Current simulation time in seconds, or 0.0 if not available
	"""
	# Try to find simulation engine if not already cached
	if simulation_engine == null:
		simulation_engine = get_node_or_null("/root/SimulationEngine")
	
	if simulation_engine != null:
		# Try to access simulation_time property directly
		if simulation_engine.has("current_simulation_time"):
			return simulation_engine.current_simulation_time
		# Or try method call
		if simulation_engine.has_method("get_current_simulation_time"):
			return simulation_engine.get_current_simulation_time()
	
	return 0.0

